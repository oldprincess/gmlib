#include <gmlib/cipher/sm4.h>
#include <gmlib/err.h>
#include <memory.h>
#include <stdlib.h>

static uint8_t key[SM4_KEYLEN] = {
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,  //
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10,  //
};

static uint8_t iv[SM4_KEYLEN] = {
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,  //
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10,  //
};

// 测试点1

static uint8_t plaintext1[] = {
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,  //
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10,  //
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,  //
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10,  //
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,  //
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10,  //
};

static uint8_t ciphertext1[] = {
    0x26, 0x77, 0xF4, 0x6B, 0x09, 0xC1, 0x22, 0xCC,  //
    0x97, 0x55, 0x33, 0x10, 0x5B, 0xD4, 0xA2, 0x2A,  //
    0xF6, 0x12, 0x5F, 0x72, 0x75, 0xCE, 0x55, 0x2C,  //
    0x3A, 0x2B, 0xBC, 0xF5, 0x33, 0xDE, 0x8A, 0x3B,  //
    0xFF, 0xF5, 0xA4, 0xF2, 0x08, 0x09, 0x2C, 0x09,  //
    0x01, 0xBA, 0x02, 0xD5, 0x77, 0x29, 0x77, 0x36,  //
    0x76, 0x71, 0x3D, 0xC4, 0x0B, 0x7F, 0x14, 0xE5,  //
    0x0B, 0x64, 0x8D, 0x1C, 0x74, 0x3F, 0xE6, 0xAF,  //
};

static uint8_t plaintext2[] = {
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,  //
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54,              //
};

static uint8_t ciphertext2[] = {
    0x97, 0x8B, 0xA5, 0xCC, 0xF7, 0x68, 0xAB, 0x0F,  //
    0x11, 0x16, 0x40, 0xCC, 0x8E, 0x94, 0xE3, 0x2A,  //
};

static uint8_t plaintext3_1[] = {
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,  //
    0xFE, 0xDC, 0xBA,                                //
};

static uint8_t plaintext3_2[] = {
    0x98, 0x76, 0x54, 0x32, 0x10,  //
};

static uint8_t ciphertext3[] = {
    0x26, 0x77, 0xF4, 0x6B, 0x09, 0xC1, 0x22, 0xCC,  //
    0x97, 0x55, 0x33, 0x10, 0x5B, 0xD4, 0xA2, 0x2A,  //
    0x3B, 0x88, 0x0E, 0x68, 0x67, 0x77, 0x25, 0x22,  //
    0xAE, 0x55, 0xD2, 0xF0, 0xAE, 0x74, 0x78, 0xAE,  //
};

static uint8_t plaintext4[] = {
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,  //
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10,  //
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,  //
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10,  //
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,  //
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10,  //
};

static uint8_t ciphertext4_1[] = {
    0x26, 0x77, 0xF4, 0x6B, 0x09, 0xC1, 0x22, 0xCC,  //
    0x97, 0x55, 0x33, 0x10, 0x5B, 0xD4, 0xA2, 0x2A,  //
    0xF6, 0x12, 0x5F, 0x72, 0x75, 0xCE, 0x55, 0x2C,  //
    0x3A, 0x2B, 0xBC, 0xF5, 0x33, 0xDE, 0x8A,        //
};

static uint8_t ciphertext4_2[] = {
    0x3B,                                            //
    0xFF, 0xF5, 0xA4, 0xF2, 0x08, 0x09, 0x2C, 0x09,  //
    0x01, 0xBA, 0x02, 0xD5, 0x77, 0x29, 0x77, 0x36,  //
    0x76, 0x71, 0x3D, 0xC4, 0x0B, 0x7F, 0x14, 0xE5,  //
    0x0B, 0x64, 0x8D, 0x1C, 0x74, 0x3F, 0xE6, 0xAF,  //
};

static uint8_t out[SM4_BLOCK_SIZE * 10];

void test_sm4_cbc() {
    SM4_CBC_CTX ctx;
    sm4_cbc_init(key, iv, &ctx);
    int outl = 0;
    uint8_t* outptr = NULL;
    // 测试点1
    sm4_cbc_reset(iv, &ctx);  // reset
    outptr = out;
    sm4_cbc_encrypt_update(outptr, &outl, plaintext1, sizeof(plaintext1), &ctx);
    outptr += outl;
    sm4_cbc_encrypt_final(outptr, &outl, &ctx);
    outptr += outl;
    if (memcmp(out, ciphertext1, sizeof(ciphertext1)) != 0 ||
        sizeof(ciphertext1) != outptr - out) {
        ERR_LOG("Err in sm4_cbc");
        goto error;
    }

    sm4_cbc_reset(iv, &ctx);  // reset
    outptr = out;
    sm4_cbc_decrypt_update(outptr, &outl, ciphertext1, sizeof(ciphertext1),
                           &ctx);
    outptr += outl;
    sm4_cbc_decrypt_final(outptr, &outl, &ctx);
    outptr += outl;
    if (memcmp(out, plaintext1, sizeof(plaintext1)) != 0 ||
        sizeof(plaintext1) != outptr - out) {
        ERR_LOG("Err in sm4_cbc");
        goto error;
    }

    // 测试点2
    sm4_cbc_reset(iv, &ctx);  // reset
    outptr = out;
    sm4_cbc_encrypt_update(outptr, &outl, plaintext2, sizeof(plaintext2), &ctx);
    outptr += outl;
    sm4_cbc_encrypt_final(outptr, &outl, &ctx);
    outptr += outl;
    if (memcmp(out, ciphertext2, sizeof(ciphertext2)) != 0 ||
        sizeof(ciphertext2) != outptr - out) {
        ERR_LOG("Err in sm4_cbc");
        goto error;
    }

    sm4_cbc_reset(iv, &ctx);  // reset
    outptr = out;
    sm4_cbc_decrypt_update(outptr, &outl, ciphertext2, sizeof(ciphertext2),
                           &ctx);
    outptr += outl;
    sm4_cbc_decrypt_final(outptr, &outl, &ctx);
    outptr += outl;
    if (memcmp(out, plaintext2, sizeof(plaintext2)) != 0 ||
        sizeof(plaintext2) != outptr - out) {
        ERR_LOG("Err in sm4_cbc");
        goto error;
    }

    // 测试点3
    sm4_cbc_reset(iv, &ctx);  // reset
    outptr = out;
    sm4_cbc_encrypt_update(outptr, &outl, plaintext3_1, sizeof(plaintext3_1),
                           &ctx);
    outptr += outl;
    sm4_cbc_encrypt_update(outptr, &outl, plaintext3_2, sizeof(plaintext3_2),
                           &ctx);
    outptr += outl;
    sm4_cbc_encrypt_final(outptr, &outl, &ctx);
    outptr += outl;
    if (memcmp(out, ciphertext3, sizeof(ciphertext3)) != 0 ||
        sizeof(ciphertext3) != outptr - out) {
        ERR_LOG("Err in sm4_cbc");
        goto error;
    }

    // 测试点4
    sm4_cbc_reset(iv, &ctx);  // reset
    outptr = out;
    sm4_cbc_decrypt_update(outptr, &outl, ciphertext4_1, sizeof(ciphertext4_1),
                           &ctx);
    outptr += outl;
    sm4_cbc_decrypt_update(outptr, &outl, ciphertext4_2, sizeof(ciphertext4_2),
                           &ctx);
    outptr += outl;
    sm4_cbc_decrypt_final(outptr, &outl, &ctx);
    outptr += outl;
    if (memcmp(out, plaintext4, sizeof(plaintext4)) != 0 ||
        sizeof(plaintext4) != outptr - out) {
        ERR_LOG("Err in sm4_cbc");
        goto error;
    }

    return;
error:
    exit(-1);
}
