#include <gmlib/cipher/sm4.h>
#include <gmlib/err.h>
#include <memory.h>
#include <stdlib.h>

static uint8_t key[SM4_KEYLEN] = {
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10,
};

static uint8_t iv[SM4_KEYLEN] = {
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10,
};

static uint8_t plaintext1[] = {
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,  //
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10,  //
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,  //
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54,
};

static uint8_t ciphertext1[] = {
    0x69, 0x3D, 0x9A, 0x53, 0x5B, 0xAD, 0x5B, 0xB1,  //
    0x78, 0x6F, 0x53, 0xD7, 0x25, 0x3A, 0x70, 0x56,  //
    0xBF, 0xB9, 0x61, 0x0E, 0xB9, 0xD1, 0x5B, 0x16,  //
    0x2D, 0xE1, 0x61, 0x75, 0x3A, 0xA7,
};

static uint8_t plaintext2[] = {
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,  //
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10,  //
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,  //
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10,  //
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,  //
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10,  //
    0x01, 0x23, 0x45, 0x67, 0x89, 0xAB, 0xCD, 0xEF,  //
    0xFE, 0xDC, 0xBA, 0x98, 0x76, 0x54, 0x32, 0x10,  //
};

static uint8_t ciphertext2[] = {
    0x69, 0x3D, 0x9A, 0x53, 0x5B, 0xAD, 0x5B, 0xB1,  //
    0x78, 0x6F, 0x53, 0xD7, 0x25, 0x3A, 0x70, 0x56,  //
    0xBF, 0xB9, 0x61, 0x0E, 0xB9, 0xD1, 0x5B, 0x16,  //
    0x2D, 0xE1, 0x61, 0x75, 0x3A, 0xA7, 0xAB, 0x84,  //
    0xC5, 0xC6, 0xBC, 0x68, 0xDF, 0x1E, 0x25, 0x0C,  //
    0x0E, 0x99, 0x24, 0x4A, 0x03, 0x3E, 0x4E, 0xF9,  //
    0xD7, 0x7E, 0xCA, 0x74, 0x38, 0xBF, 0xEE, 0x95,  //
    0x7B, 0x7E, 0x04, 0xB7, 0x74, 0xC2, 0x3B, 0xE7,  //
};

static uint8_t out[SM4_BLOCK_SIZE * 10];

void test_sm4_ctr() {
    SM4_CTR_CTX ctx;
    sm4_ctr_init(key, iv, &ctx);
    int outl;
    uint8_t* outptr;
    // 测试点1
    sm4_ctr_reset(iv, &ctx);  // reset
    outptr = out;
    sm4_ctr_encrypt_update(outptr, &outl, plaintext1, sizeof(plaintext1), &ctx);
    outptr += outl;
    sm4_ctr_encrypt_final(outptr, &outl, &ctx);
    outptr += outl;
    if (memcmp(out, ciphertext1, sizeof(ciphertext1)) != 0 ||
        sizeof(ciphertext1) != outptr - out) {
        ERR_LOG("Err in sm4_ctr");
        goto error;
    }

    sm4_ctr_reset(iv, &ctx);  // reset
    outptr = out;
    sm4_ctr_decrypt_update(outptr, &outl, ciphertext1, sizeof(ciphertext1),
                           &ctx);
    outptr += outl;
    sm4_ctr_decrypt_final(outptr, &outl, &ctx);
    outptr += outl;
    if (memcmp(out, plaintext1, sizeof(plaintext1)) != 0 ||
        sizeof(plaintext1) != outptr - out) {
        ERR_LOG("Err in sm4_ctr");
        goto error;
    }

    // 测试点2
    sm4_ctr_reset(iv, &ctx);  // reset
    outptr = out;
    sm4_ctr_encrypt_update(outptr, &outl, plaintext2, sizeof(plaintext2), &ctx);
    outptr += outl;
    sm4_ctr_encrypt_final(outptr, &outl, &ctx);
    outptr += outl;
    if (memcmp(out, ciphertext2, sizeof(ciphertext2)) != 0 ||
        sizeof(ciphertext2) != outptr - out) {
        ERR_LOG("Err in sm4_ctr");
        goto error;
    }

    sm4_ctr_reset(iv, &ctx);  // reset
    outptr = out;
    sm4_ctr_decrypt_update(outptr, &outl, ciphertext2, sizeof(ciphertext2),
                           &ctx);
    outptr += outl;
    sm4_ctr_decrypt_final(outptr, &outl, &ctx);
    outptr += outl;
    if (memcmp(out, plaintext2, sizeof(plaintext2)) != 0 ||
        sizeof(plaintext2) != outptr - out) {
        ERR_LOG("Err in sm4_ctr");
        goto error;
    }

    // 测试点3
    sm4_ctr_reset(iv, &ctx);  // reset
    outptr = out;
    sm4_ctr_encrypt_update(outptr, &outl, plaintext2, sizeof(plaintext2) - 3,
                           &ctx);
    outptr += outl;
    sm4_ctr_encrypt_update(outptr, &outl, plaintext2 + sizeof(plaintext2) - 3,
                           3, &ctx);
    outptr += outl;
    sm4_ctr_encrypt_final(outptr, &outl, &ctx);
    outptr += outl;
    if (memcmp(out, ciphertext2, sizeof(ciphertext2)) != 0 ||
        sizeof(ciphertext2) != outptr - out) {
        ERR_LOG("Err in sm4_ctr");
        goto error;
    }

    return;

error:
    exit(-1);
}
